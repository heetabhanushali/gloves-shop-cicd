version: '3.8'

networks:
  gloves-shop:
    driver: bridge

services:
  # ===========================================
  # DATABASES
  # ===========================================
  mongodb:
    build:
      context: ./mongo
    image: heeta/gloves-shop-mongodb:1.0.0
    platform: linux/amd64
    container_name: gloves-shop-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    restart: unless-stopped
    networks:
      - gloves-shop
    

  redis:
    image: redis:6.2-alpine
    container_name: gloves-shop-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    restart: unless-stopped
    networks:
      - gloves-shop

  rabbitmq:
    image: rabbitmq:3.8-management-alpine
    container_name: gloves-shop-rabbitmq
    ports:
      - "15672:15672"
      - "5672:5672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    restart: unless-stopped
    networks:
      - gloves-shop

  mysql:
    build:
      context: ./mysql
    image: heeta/gloves-shop-mysql:1.0.0
    platform: linux/amd64
    container_name: gloves-shop-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    restart: unless-stopped
    networks:
      - gloves-shop

  # ===========================================
  # MICROSERVICES
  # ===========================================
  catalogue:
    build:
      context: ./catalogue
    image: heeta/gloves-shop-catalogue:1.0.0
    platform: linux/amd64
    container_name: gloves-shop-catalogue
    environment:
      MONGO_URL: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017/catalogue?authSource=admin
    depends_on:
      - mongodb
    restart: unless-stopped
    networks:
      - gloves-shop

  user:
    build:
      context: ./user
    image: heeta/gloves-shop-user:1.0.0
    platform: linux/amd64
    container_name: gloves-shop-user
    environment:
      MONGO_URL: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017/users?authSource=admin
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    depends_on:
      - mongodb
      - redis
    restart: unless-stopped
    networks:
      - gloves-shop

  cart:
    build:
      context: ./cart
    image: heeta/gloves-shop-cart:1.0.0
    platform: linux/amd64
    container_name: gloves-shop-cart
    environment:
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      CATALOGUE_HOST: catalogue
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - gloves-shop

  shipping:
    build:
      context: ./shipping
    image: heeta/gloves-shop-shipping:1.0.0
    platform: linux/amd64
    container_name: gloves-shop-shipping
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/${MYSQL_DATABASE}?useSSL=false&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
    depends_on:
      - mysql
    restart: unless-stopped
    networks:
      - gloves-shop

  ratings:
    build:
      context: ./ratings
    image: heeta/gloves-shop-ratings:1.0.0
    platform: linux/amd64
    container_name: gloves-shop-ratings
    environment:
      MYSQL_HOST: mysql
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    depends_on:
      - mysql
    restart: unless-stopped
    networks:
      - gloves-shop

  payment:
    build:
      context: ./payment
    image: heeta/gloves-shop-payment:1.0.0
    platform: linux/amd64
    container_name: gloves-shop-payment
    environment:
      AMQP_HOST: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      CART_HOST: cart
      USER_HOST: user
    depends_on:
      - rabbitmq
    restart: unless-stopped
    networks:
      - gloves-shop

  dispatch:
    build:
      context: ./dispatch
    image: heeta/gloves-shop-dispatch:1.0.0
    platform: linux/amd64
    container_name: gloves-shop-dispatch
    environment:
      AMQP_HOST: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
    depends_on:
      - rabbitmq
    restart: unless-stopped
    networks:
      - gloves-shop

  # ===========================================
  # FRONTEND
  # ===========================================
  web:
    build:
      context: ./web
    image: heeta/gloves-shop-web:1.0.0
    platform: linux/amd64
    container_name: gloves-shop-web
    ports:
      - "8080:8080"
    depends_on:
      - catalogue
      - user
      - cart
      - shipping
      - payment
      - ratings
    environment:
      - CATALOGUE_HOST=catalogue
      - USER_HOST=user
      - CART_HOST=cart
      - SHIPPING_HOST=shipping
      - PAYMENT_HOST=payment
      - RATINGS_HOST=ratings
    restart: unless-stopped
    networks:
      - gloves-shop

  # ===========================================
  # MONITORING STACK
  # ===========================================
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: gloves-shop-cadvisor
    ports:
      - "8081:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    networks:
      - gloves-shop

  prometheus:
    image: prom/prometheus
    container_name: gloves-shop-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - gloves-shop

  grafana:
    image: grafana/grafana
    container_name: gloves-shop-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    depends_on:
      - prometheus
    networks:
      - gloves-shop